<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Programa√ß√£o de Aplica√ß√£o ‚Äî Top Gun</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="%230d6efd"/><path d="M16 40l16-24 16 24H16z" fill="white"/></svg>'>

<style>
  body { background:#f8f9fa; }
  .card { border-radius:.75rem; }
  .form-section-title{font-weight:600;font-size:1rem;color:#0d6efd;display:flex;align-items:center;gap:.5rem;}
  pre#preview{white-space:pre-wrap;min-height:260px;}
  label { display:inline-block; margin-bottom:.25rem; }
  .fazenda-card{border:1px solid #e9ecef;border-radius:.75rem;padding:1rem;margin-bottom:.75rem;background:#fff}
  .fazenda-card + .fazenda-card{border-top:2px dashed #dee2e6; margin-top:.5rem; padding-top:1rem}
  .badge-counter{font-weight:600}
  .talhoes-wrap .row + .row{margin-top:.5rem}
</style>
</head>
<body>
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-calendar-check text-primary fs-4"></i>
      <h1 class="h4 mb-0">Programa√ß√£o de Aplica√ß√£o ‚Äî Top Gun</h1>
      <span class="badge text-bg-light border">v3 (com rendimento)</span>
    </div>
    <a href="index.html" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar para o In√≠cio
    </a>
  </div>

  <div class="row g-3">
    <!-- FORM PRINCIPAL -->
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-body">
          <div class="form-section-title mb-3"><i class="bi bi-ui-checks-grid"></i> Preenchimento</div>

          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label for="dataAplicacao" class="form-label">Data para aplica√ß√£o</label>
              <input type="date" id="dataAplicacao" class="form-control">
            </div>
            <div class="col-12 col-md-4">
              <label for="estado" class="form-label">Estado</label>
              <select id="estado" class="form-select">
                <option value="">Selecione...</option>
                <option value="MG">Minas Gerais (MG)</option>
                <option value="SP">S√£o Paulo (SP)</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label for="unidade" class="form-label">Unidade</label>
              <select id="unidade" class="form-select" disabled>
                <option value="">Selecione o Estado</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label for="frente" class="form-label">Frente</label>
              <select id="frente" class="form-select">
                <option value="">Selecione...</option>
                <option value="Frente 1">Frente 1</option>
                <option value="Frente 2">Frente 2</option>
                <option value="Frente 3">Frente 3</option>
                <option value="Frente 4">Frente 4</option>
                <option value="Frente 5">Frente 5</option>
                <option value="Frente 6">Frente 6</option>
                <option value="Frente 7">Frente 7</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label for="piloto" class="form-label">Piloto</label>
              <input id="piloto" class="form-control" placeholder="Preenchido pela Frente" readonly>
            </div>
            <div class="col-12 col-md-4">
              <label for="auxiliar" class="form-label">Auxiliar</label>
              <select id="auxiliar" class="form-select">
                <option value="">Selecione...</option>
                <option>Ailton Gabriel</option>
                <option>Yuri Joudran</option>
                <option>Pedro Henrique</option>
                <option>Jefferson Lopes</option>
                <option>Jonathan Vieira</option>
                <option>Luiz Gustavo</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label for="drone" class="form-label">Drone</label>
              <select id="drone" class="form-select">
                <option value="">Selecione...</option>
                <option>DJI AGRAS T20</option>
                <option>DJI AGRAS T40</option>
                <option>DJI AGRAS T70</option>
                <option>DJI AGRAS T100</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label for="objetivo" class="form-label">Objetivo</label>
              <select id="objetivo" class="form-select">
                <option value="">Selecione...</option>
                <option>√Årea Total</option>
                <option>Cata√ß√£o</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label for="tipoProduto" class="form-label">Tipo de Produto</label>
              <select id="tipoProduto" class="form-select">
                <option value="">Selecione...</option>
                <option>Herbicida</option>
                <option>Inseticida</option>
                <option>Fungicida</option>
                <option>Fertilizante</option>
              </select>
            </div>
          </div>

          <hr class="my-4">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="form-section-title mb-0"><i class="bi bi-building"></i> Fazendas</div>
          </div>

          <!-- Container din√¢mico de fazendas -->
          <div id="fazendasContainer"></div>

          <div class="col-12 d-flex flex-wrap gap-2 mt-3">
            <button id="btnGerar" class="btn btn-primary"><i class="bi bi-chat-left-text"></i> Gerar texto</button>
            <button id="btnCopiar" class="btn btn-outline-secondary"><i class="bi bi-clipboard"></i> Copiar</button>
            <a id="btnWhats" class="btn btn-success" target="_blank" rel="noopener"><i class="bi bi-whatsapp"></i> WhatsApp</a>
          </div>
        </div>
      </div>
    </div>

    <!-- PR√âVIA -->
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="form-section-title mb-2"><i class="bi bi-file-earmark-text"></i> Pr√©via do texto</div>
          <pre id="preview" class="border rounded p-3 bg-light">Preencha e adicione as fazendas. Depois clique em ‚ÄúGerar texto‚Äù.</pre>
          <div class="mt-2">
            <span class="badge text-bg-light border me-1 badge-counter" id="badgeFaz">Fazendas: 0</span>
            <span class="badge text-bg-light border badge-counter" id="badgeArea">√Årea: 0 ha</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-4">
    <a href="index.html" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar para o In√≠cio
    </a>
  </div>

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
    <div id="toastCopiado" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body"><i class="bi bi-check-circle me-2"></i>Texto copiado!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

</div>

<script>
  // ===== CONFIG =====
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0wYo2B8wXXv_SqVwVayNkDtG_UsroXNXfLk970sHff6cIXnayykA3DYqtrt0ldefP/exec';

  const FRentesPilotos = {
    'Frente 1':'Matheus Pias','Frente 2':'Maicon Silva','Frente 3':'Alexandre Alves',
    'Frente 4':'Felipe Santos','Frente 5':'Luiz Paulo','Frente 6':'Sem Piloto Cadastrado na Frente','Frente 7':'Heitor Ferreira'
  };
  const UnidadesPorEstado = {
    'MG':['Delta - Delta','Delta - Volta Grande','Florestadora - Santa Cec√≠lia (Jo√£o Pinheiro - MG)','Parque de Bioenergia Lagoa da Prata (Lagoa da Prata - MG)'],
    'SP':['Usina Gasa (Andradina - SP)','Usina Rafard (Rafard - SP)','Usina S√£o Francisco (Elias Fausto - SP)','Usina Barra Bonita (Barra Bonita - SP)','Usina Costa Pinto (Piracicaba - SP)','Usina Leme (Leme - SP)','Usina Destivale (Ara√ßatuba - SP)','Usina Mundial (Mirand√≥polis - SP)','Usina Ipaussu (Ipaussu - SP)','Usina Diamante (Ja√∫ - SP)','Usina Univalem (Valpara√≠so - SP)','Usina Ben√°lcool (Bento de Abreu - SP)']
  };

  // Estado ‚Üí Unidade
  const estadoSel = document.getElementById('estado');
  const unidadeSel = document.getElementById('unidade');
  estadoSel.addEventListener('change', function() {
    unidadeSel.innerHTML = '';
    const uf = this.value;
    if (!uf) {
      unidadeSel.disabled = true;
      unidadeSel.innerHTML = '<option>Selecione o Estado</option>';
      return;
    }
    unidadeSel.disabled = false;
    unidadeSel.insertAdjacentHTML('beforeend', '<option value="">Selecione...</option>');
    (UnidadesPorEstado[uf] || []).forEach(u => {
      const o = document.createElement('option'); o.value = u; o.textContent = u; unidadeSel.appendChild(o);
    });
  });

  // Frente ‚Üí Piloto
  document.getElementById('frente').addEventListener('change',function(){
    document.getElementById('piloto').value = this.value ? (FRentesPilotos[this.value]||'') : '';
  });

  // ===== JSONP =====
  function jsonp(urlString){
    const url = new URL(urlString);
    const cb  = '__jsonp_' + Math.random().toString(36).slice(2);
    url.searchParams.set('callback', cb);
    const src = url.toString();
    return new Promise((resolve, reject)=>{
      const s = document.createElement('script');
      s.src = src;
      window[cb] = (data)=>{ resolve(data); cleanup(); };
      s.onerror = ()=>{ reject(new Error('Falha no JSONP')); cleanup(); };
      function cleanup(){ delete window[cb]; s.remove(); }
      document.body.appendChild(s);
    });
  }

  // ===== FAZENDAS DIN√ÇMICAS =====
  const fazendasContainer = document.getElementById('fazendasContainer');

  // cria 1 bloco inicial
  addFazenda();

  function addFazenda(prefillOS=''){
    const idx = Date.now().toString(36);
    const el = document.createElement('div');
    el.className = 'fazenda-card';
    el.dataset.idx = idx;
    el.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-semibold text-secondary"><i class="bi bi-geo-alt"></i> Fazenda</div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-secondary" data-add="${idx}">
            <i class="bi bi-plus-circle"></i> Adicionar
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger" data-remove="${idx}">
            <i class="bi bi-x-lg"></i> Remover
          </button>
        </div>
      </div>

      <!-- PROGRAMA√á√ÉO (OS / C√≥digo / etc.) -->
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-6">
          <label class="form-label" for="os_${idx}">OS</label>
          <div class="input-group">
            <input id="os_${idx}" class="form-control" placeholder="Digite a OS">
            <button class="btn btn-outline-primary" data-buscar="${idx}" title="Buscar OS"><i class="bi bi-search"></i></button>
          </div>
          <div class="form-text">Busca autom√°tica na planilha.</div>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label" for="codigo_${idx}">C√≥digo</label>
          <input id="codigo_${idx}" class="form-control" readonly>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label" for="fazenda_${idx}">Fazenda</label>
          <input id="fazenda_${idx}" class="form-control" readonly>
        </div>
        <div class="col-6 col-md-4">
          <label class="form-label" for="area_${idx}">√Årea (ha)</label>
          <input id="area_${idx}" class="form-control" readonly>
        </div>
        <div class="col-6 col-md-4">
          <label class="form-label" for="operacao_${idx}">Opera√ß√£o</label>
          <input id="operacao_${idx}" class="form-control" readonly>
        </div>
        <div class="col-12">
          <label class="form-label" for="insumos_${idx}">Insumos</label>
          <textarea id="insumos_${idx}" class="form-control" rows="2" readonly></textarea>
        </div>
      </div>

      <!-- RENDIMENTO -->
      <hr>
      <div class="form-section-title mb-2"><i class="bi bi-speedometer2"></i> Rendimento</div>
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <label class="form-label" for="status_${idx}">Status</label>
          <select id="status_${idx}" class="form-select">
            <option value="">Selecione...</option>
            <option>Em andamento</option>
            <option>Finalizado</option>
          </select>
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Sobrou produto?</label>
          <div class="input-group">
            <select id="sobrou_${idx}" class="form-select">
              <option>N√£o</option>
              <option>Sim</option>
            </select>
            <input id="sobrou_qtd_${idx}" class="form-control" placeholder="Quantidade (ex: 5 L)" style="display:none;">
          </div>
          <div class="form-text">Se marcar "Sim", informe a quantidade.</div>
        </div>
      </div>

      <!-- TALH√ïES -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="form-section-title mb-0"><i class="bi bi-diagram-3"></i> Talh√µes</div>
        <button type="button" class="btn btn-sm btn-outline-primary" data-add-talhao="${idx}">
          <i class="bi bi-plus"></i> Adicionar talh√£o
        </button>
      </div>
      <div class="talhoes-wrap" id="talhoes_${idx}">
        <!-- linhas de talh√£o entram aqui -->
      </div>
    `;
    fazendasContainer.appendChild(el);

    // eventos do bloco
    el.querySelector(`[data-remove="${idx}"]`).addEventListener('click', ()=>{ el.remove(); updateResumo(); gerarTexto(); });
    el.querySelector(`[data-add="${idx}"]`).addEventListener('click', ()=>{ addFazenda(); });
    el.querySelector(`[data-buscar="${idx}"]`).addEventListener('click', ()=> buscarOS(idx));
    el.querySelector(`[data-add-talhao="${idx}"]`).addEventListener('click', ()=> addTalhao(idx));

    const osInput = el.querySelector(`#os_${idx}`);
    osInput.addEventListener('input', ()=>{
      clearOne(idx);
      const v = osInput.value.trim();
      if (!v) return;
      debounce(()=> buscarOS(idx), 350);
    });

    // mostrar/ocultar quantidade de sobra
    const sobrouSel = el.querySelector(`#sobrou_${idx}`);
    const sobrouQtd = el.querySelector(`#sobrou_qtd_${idx}`);
    sobrouSel.addEventListener('change', ()=>{
      const show = sobrouSel.value === 'Sim';
      sobrouQtd.style.display = show ? '' : 'none';
      if (!show) sobrouQtd.value = '';
      gerarTexto();
    });

    if (prefillOS) { osInput.value = prefillOS; buscarOS(idx); }
  }

  function addTalhao(idx){
    const wrap = document.getElementById(`talhoes_${idx}`);
    const rowId = Date.now().toString(36);
    const row = document.createElement('div');
    row.className = 'row g-2 align-items-end';
    row.dataset.row = rowId;
    row.innerHTML = `
      <div class="col-6 col-md-3">
        <label class="form-label" for="talhao_${idx}_${rowId}">Talh√£o</label>
        <input id="talhao_${idx}_${rowId}" class="form-control" placeholder="N¬∫">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label" for="qtd_${idx}_${rowId}">Qtd. aplicada (ha)</label>
        <input id="qtd_${idx}_${rowId}" class="form-control" placeholder="ex: 3.50">
      </div>
      <div class="col-12 col-md-3">
        <button type="button" class="btn btn-outline-danger mt-4" data-del="${rowId}">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    `;
    wrap.appendChild(row);

    row.querySelector(`[data-del="${rowId}"]`).addEventListener('click', ()=>{
      row.remove(); gerarTexto();
    });

    // atualizar preview quando digitar
    row.querySelector(`#talhao_${idx}_${rowId}`).addEventListener('input', gerarTexto);
    row.querySelector(`#qtd_${idx}_${rowId}`).addEventListener('input', gerarTexto);
  }

  function clearOne(idx){
    getEl(`#codigo_${idx}`).value='';
    getEl(`#fazenda_${idx}`).value='';
    getEl(`#area_${idx}`).value='';
    getEl(`#operacao_${idx}`).value='';
    getEl(`#insumos_${idx}`).value='';
  }

  function getEl(sel){ return document.querySelector(sel); }

  let debTimer;
  function debounce(fn, t){ clearTimeout(debTimer); debTimer=setTimeout(fn, t); }

  async function buscarOS(idx){
    try{
      const osVal = getEl(`#os_${idx}`).value.trim();
      if(!osVal){ clearOne(idx); updateResumo(); return; }
      const js = await jsonp(APPS_SCRIPT_URL + '?os=' + encodeURIComponent(osVal));
      if(!js.ok || !js.rows || !js.rows.length){ clearOne(idx); updateResumo(); return; }

      const row = js.rows.find(x => String(x.OS)===String(osVal)) || js.rows[0];
      const get = k => row[k] ?? row[k?.toUpperCase()] ?? '';

      getEl(`#codigo_${idx}`).value   = get('CODIGO');
      getEl(`#fazenda_${idx}`).value  = get('FAZENDA');
      getEl(`#area_${idx}`).value     = (get('AREA (HA)') || '').toString().replace(',','.');
      getEl(`#operacao_${idx}`).value = get('OPERACAO');
      getEl(`#insumos_${idx}`).value  = get('INSUMOS');

      const objetivoSel = document.getElementById('objetivo');
      const objetivoStr = get('OBJETIVO');
      if (objetivoStr) {
        [...objetivoSel.options].forEach(o=>{
          if (o.value.toUpperCase() === String(objetivoStr).toUpperCase())
            objetivoSel.value = o.value;
        });
      }

      updateResumo();
      gerarTexto();
    }catch(e){
      console.error(e);
      clearOne(idx); updateResumo();
    }
  }

  function updateResumo(){
    const cards = [...fazendasContainer.querySelectorAll('.fazenda-card')];
    let totalFaz = 0, totalArea = 0;
    cards.forEach(c=>{
      const faz = c.querySelector('[id^="fazenda_"]').value.trim();
      const areaStr = c.querySelector('[id^="area_"]').value.trim();
      if (faz) totalFaz++;
      const v = parseFloat((areaStr||'').toString().replace(',','.'));
      if (!isNaN(v)) totalArea += v;
    });
    document.getElementById('badgeFaz').textContent  = `Fazendas: ${totalFaz}`;
    const totalAreaFixed = Number(totalArea.toFixed(2));
    const totalAreaFmt = totalAreaFixed.toFixed(2).replace('.',',') + ' ha';
    document.getElementById('badgeArea').textContent = `√Årea: ${totalAreaFmt}`;
  }

  // ===== GERA√á√ÉO DO TEXTO/WHATS/COPIAR =====
  const preview=document.getElementById('preview');
  document.getElementById('btnGerar').addEventListener('click', gerarTexto);
  document.getElementById('btnCopiar').addEventListener('click', ()=>{
    navigator.clipboard.writeText(preview.textContent||'').then(()=>{
      new bootstrap.Toast(document.getElementById('toastCopiado')).show();
    });
  });

  function gerarTexto(){
    const data=(document.getElementById('dataAplicacao').value||'').split('-').reverse().join('/');
    const unidade=document.getElementById('unidade').value;
    const frente =document.getElementById('frente').value;
    const piloto =document.getElementById('piloto').value;
    const auxiliar=document.getElementById('auxiliar').value;
    const drone  =document.getElementById('drone').value;
    const objetivo=document.getElementById('objetivo').value;
    const tipoProduto=document.getElementById('tipoProduto').value;

    const cards = [...fazendasContainer.querySelectorAll('.fazenda-card')];
    let blocos = [];
    let totalFaz = 0, totalAreaProg = 0, totalAreaApl = 0;

    cards.forEach(c=>{
      const os       = c.querySelector('[id^="os_"]').value.trim();
      const codigo   = c.querySelector('[id^="codigo_"]').value.trim();
      const fazenda  = c.querySelector('[id^="fazenda_"]').value.trim();
      const areaStr  = c.querySelector('[id^="area_"]').value.trim();
      const operacao = c.querySelector('[id^="operacao_"]').value.trim();
      const insumos  = c.querySelector('[id^="insumos_"]').value.trim();
      const status   = c.querySelector('[id^="status_"]').value.trim();
      const sobrou   = c.querySelector('[id^="sobrou_"]').value.trim();
      const sobrouQtd= c.querySelector('[id^="sobrou_qtd_"]').value.trim();

      if (fazenda) totalFaz++;
      const vProg = parseFloat((areaStr||'').toString().replace(',','.'));
      if (!isNaN(vProg)) totalAreaProg += vProg;

      // talh√µes
      const talhoesWrap = c.querySelector('.talhoes-wrap');
      const linhas = [...talhoesWrap.querySelectorAll('.row')];
      let talhoesTxt = [];
      let somaApl = 0;
      linhas.forEach(r=>{
        const t = r.querySelector('[id^="talhao_"]')?.value.trim();
        const q = r.querySelector('[id^="qtd_"]')?.value.trim();
        if (t || q){
          const qNum = parseFloat((q||'').toString().replace(',','.'));
          if (!isNaN(qNum)) somaApl += qNum;
          const qFmt = q ? `${q} ha` : '-';
          talhoesTxt.push(`- Talh√£o ${t||'-'}: ${qFmt}`);
        }
      });
      totalAreaApl += somaApl;

      const areaClean = (areaStr || '').toString().replace(/\s*ha$/i, '').trim();
      const areaFmt = areaClean ? `${areaClean} ha` : '-';

      const bloco =
`*üìã OS:* ${os || '-'}
*C√≥digo:* ${codigo || '-'}
*Fazenda:* ${fazenda || '-'}
*√Årea (ha):* ${areaFmt}
*Opera√ß√£o:* ${operacao || '-'}
*Insumos:* ${insumos || '-'}
*Status:* ${status || '-'}

*Talh√µes:*
${talhoesTxt.length ? talhoesTxt.join('\n') : '-'}
*Subtotal aplicado (ha):* ${somaApl ? somaApl.toFixed(2).replace('.',',') : '0,00'}
*Sobrou produto:* ${sobrou === 'Sim' ? (sobrouQtd || '-') : 'N√£o'}`;

      blocos.push(bloco);
    });

    const header =
`üìÖ *Programa√ß√£o para aplica√ß√£o:* ${data}

*Unidade:* ${unidade||'-'}
*Frente:* ${frente||'-'}
*Piloto:* ${piloto||'-'}
*Auxiliar:* ${auxiliar||'-'}
*Drone:* ${drone||'-'}
*Objetivo:* ${objetivo||'-'}
*Tipo de Produto:* ${tipoProduto||'-'}`;

    const resumo =
`\n*Resumo Geral:*
*Qtd. Fazendas:* ${totalFaz}
*√Årea programada (ha):* ${totalAreaProg.toFixed(2).replace('.',',')}
*√Årea aplicada (ha):* ${totalAreaApl.toFixed(2).replace('.',',')}`;

    const sepLine = '_______';
    const blocosTexto = blocos.length ? blocos.map(b => b + '\n' + sepLine).join('\n\n') : '';

    const textoFinal = header + (blocosTexto ? ('\n\n' + blocosTexto + '\n\n') : '\n\n') + resumo;

    preview.textContent = textoFinal;
    document.getElementById('btnWhats').href = 'https://wa.me/?text=' + encodeURIComponent(textoFinal);
    updateResumo();
  }
</script>
</body>
</html>
