<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Programa√ß√£o de Aplica√ß√£o ‚Äî Top Gun</title>

<!-- Bootstrap 5 + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Favicon embutido (acaba com o 404) -->
<link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="%230d6efd"/><path d="M16 40l16-24 16 24H16z" fill="white"/></svg>'>

<style>
  body { background:#f8f9fa; }
  .card { border-radius:.75rem; }
  .form-section-title{
    font-weight:600; font-size:1rem; color:#0d6efd;
    display:flex; align-items:center; gap:.5rem;
  }
  pre#preview{ white-space:pre-wrap; min-height:260px; }
</style>
</head>
<body>
<div class="container py-4">

  <!-- Topo -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-calendar-check text-primary fs-4"></i>
      <h1 class="h4 mb-0">Programa√ß√£o de Aplica√ß√£o ‚Äî Top Gun</h1>
      <span class="badge text-bg-light border">v1 (tema claro)</span>
    </div>
    <a href="index.html" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar para o In√≠cio
    </a>
  </div>

  <div class="row g-3">
    <!-- FORM -->
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-body">
          <div class="form-section-title mb-3">
            <i class="bi bi-ui-checks-grid"></i> Preenchimento
          </div>

          <div class="row g-3">
            <!-- Linha 1 -->
            <div class="col-12 col-md-4">
              <label class="form-label">Data para aplica√ß√£o</label>
              <input type="date" id="dataAplicacao" class="form-control">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Estado</label>
              <select id="estado" class="form-select">
                <option value="">Selecione...</option>
                <option value="MG">Minas Gerais (MG)</option>
                <option value="SP">S√£o Paulo (SP)</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Unidade</label>
              <select id="unidade" class="form-select" disabled>
                <option value="">Selecione o Estado</option>
              </select>
            </div>

            <!-- Linha 2 -->
            <div class="col-12 col-md-4">
              <label class="form-label">Frente</label>
              <select id="frente" class="form-select">
                <option value="">Selecione...</option>
                <option value="Frente 1">Frente 1</option>
                <option value="Frente 2">Frente 2</option>
                <option value="Frente 3">Frente 3</option>
                <option value="Frente 4">Frente 4</option>
                <option value="Frente 5">Frente 5</option>
                <option value="Frente 6">Frente 6</option>
                <option value="Frente 7">Frente 7</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Piloto</label>
              <input id="piloto" class="form-control" placeholder="Preenchido pela Frente" readonly>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Auxiliar</label>
              <select id="auxiliar" class="form-select">
                <option value="">Selecione...</option>
                <option>Ailton Gabriel</option>
                <option>Yuri Joudran</option>
                <option>Pedro Henrique</option>
                <option>Jefferson Lopes</option>
                <option>Jonathan Vieira</option>
                <option>Luiz Gustavo</option>
              </select>
            </div>

            <!-- Linha 3 -->
            <div class="col-12 col-md-4">
              <label class="form-label">Drone</label>
              <select id="drone" class="form-select">
                <option value="">Selecione...</option>
                <option>DJI AGRAS T20</option>
                <option>DJI AGRAS T40</option>
                <option>DJI AGRAS T70</option>
                <option>DJI AGRAS T100</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Objetivo</label>
              <select id="objetivo" class="form-select">
                <option value="">Selecione...</option>
                <option>√Årea Total</option>
                <option>Cata√ß√£o</option>
              </select>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Tipo de Produto</label>
              <select id="tipoProduto" class="form-select">
                <option value="">Selecione...</option>
                <option>Herbicida</option>
                <option>Inseticida</option>
                <option>Fungicida</option>
                <option>Fertilizante</option>
              </select>
            </div>

            <div class="col-12"><hr></div>

            <!-- OS + Busca -->
            <div class="col-12 col-md-6">
              <label class="form-label">OS</label>
              <div class="input-group">
                <input id="os" class="form-control" placeholder="Digite a OS">
                <button id="btnBuscarOS" class="btn btn-outline-primary">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              <div class="form-text">Busca autom√°tica na planilha.</div>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">C√≥digo</label>
              <input id="codigo" class="form-control" readonly>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Fazenda</label>
              <input id="fazenda" class="form-control" readonly>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">√Årea (ha)</label>
              <input id="area" class="form-control" readonly>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Opera√ß√£o</label>
              <input id="operacao" class="form-control" readonly>
            </div>
            <div class="col-12">
              <label class="form-label">Insumos</label>
              <textarea id="insumos" class="form-control" rows="2" readonly></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">Observa√ß√µes (opcional)</label>
              <textarea id="observacoes" class="form-control" rows="2" placeholder="Preencha apenas se necess√°rio"></textarea>
            </div>

            <div class="col-12 d-flex flex-wrap gap-2 mt-2">
              <button id="btnGerar" class="btn btn-primary">
                <i class="bi bi-chat-left-text"></i> Gerar texto
              </button>
              <button id="btnCopiar" class="btn btn-outline-secondary">
                <i class="bi bi-clipboard"></i> Copiar
              </button>
              <a id="btnWhats" class="btn btn-success" target="_blank" rel="noopener">
                <i class="bi bi-whatsapp"></i> WhatsApp
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pr√©via -->
    <div class="col-12 col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="form-section-title mb-2">
            <i class="bi bi-file-earmark-text"></i> Pr√©via do texto
          </div>
          <pre id="preview" class="border rounded p-3 bg-light">Preencha os campos e clique em ‚ÄúGerar texto‚Äù.</pre>
          <div class="mt-2">
            <span class="badge text-bg-light border me-1" id="badgeFaz">Fazendas: 0</span>
            <span class="badge text-bg-light border" id="badgeArea">√Årea: 0 ha</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rodap√©: Voltar -->
  <div class="text-center mt-4">
    <a href="index.html" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar para o In√≠cio
    </a>
  </div>

  <!-- Toast Copiado -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
    <div id="toastCopiado" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body"><i class="bi bi-check-circle me-2"></i>Texto copiado!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

</div>

<script>
  // Endpoint do seu Apps Script (executando JSONP)
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyumH5NY1N8AwoeQRpsvRQwUsCReGEwDQPYhX36iPGnxmgTcxc02tEZ5qe6QnLixOB2/exec';

  // Frente ‚Üí Piloto
  const FRentesPilotos = {
    'Frente 1':'Matheus Pias','Frente 2':'Maicon Silva','Frente 3':'Alexandre Alves',
    'Frente 4':'Felipe Santos','Frente 5':'Luiz Paulo','Frente 6':'Sem Piloto Cadastrado na Frente','Frente 7':'Heitor Ferreira'
  };

  // Estado ‚Üí Unidade
  const UnidadesPorEstado = {
    'MG':['Delta - Delta','Delta - Volta Grande','Florestadora - Santa Cec√≠lia (Jo√£o Pinheiro - MG)','Parque de Bioenergia Lagoa da Prata (Lagoa da Prata - MG)'],
    'SP':['Usina Gasa (Andradina - SP)','Usina Rafard (Rafard - SP)','Usina S√£o Francisco (Elias Fausto - SP)','Usina Barra Bonita (Barra Bonita - SP)','Usina Costa Pinto (Piracicaba - SP)','Usina Leme (Leme - SP)','Usina Destivale (Ara√ßatuba - SP)','Usina Mundial (Mirand√≥polis - SP)','Usina Ipaussu (Ipaussu - SP)','Usina Diamante (Ja√∫ - SP)','Usina Univalem (Valpara√≠so - SP)','Usina Ben√°lcool (Bento de Abreu - SP)']
  };

  // Estado ‚Üí Unidade (UI)
  const estadoSel=document.getElementById('estado');
  const unidadeSel=document.getElementById('unidade');
  estadoSel.addEventListener('change',()=>{
    unidadeSel.innerHTML='';
    const uf=estadoSel.value;
    if(!uf){unidadeSel.disabled=true;unidadeSel.innerHTML='<option>Selecione o Estado</option>';return;}
    unidadeSel.disabled=false;
    unidadeSel.insertAdjacentHTML('beforeend','<option value="">Selecione...</option>');
    (UnidadesPorEstado[uf]||[]).forEach(u=>{
      const o=document.createElement('option');o.value=u;o.textContent=u;unidadeSel.appendChild(o);
    });
  });

  // Frente ‚Üí Piloto (UI)
  const frenteSel=document.getElementById('frente');
  const pilotoInp=document.getElementById('piloto');
  frenteSel.addEventListener('change',()=>{pilotoInp.value=frenteSel.value?(FRentesPilotos[frenteSel.value]||''):'';});

  // ===== JSONP helper (evita CORS) =====
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = '__jsonp_' + Math.random().toString(36).slice(2);
      const s  = document.createElement('script');
      const hasQuery = url.includes('?');
      const sep = hasQuery ? '&' : '?';
      s.src = url + sep + 'callback=' + cb;
      window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
      s.onerror = () => { delete window[cb]; s.remove(); reject(new Error('Falha no JSONP')); };
      document.body.appendChild(s);
    });
  }

  // Busca por OS (auto + bot√£o)
  const osInp=document.getElementById('os'),
        codigoInp=document.getElementById('codigo'),
        fazendaInp=document.getElementById('fazenda'),
        areaInp=document.getElementById('area'),
        operacaoInp=document.getElementById('operacao'),
        insumosTA=document.getElementById('insumos');

  let debounceTimer;
  osInp.addEventListener('input',()=>{
    clearTimeout(debounceTimer);
    const v=osInp.value.trim();
    if(!v){clearOSFields();return;}
    debounceTimer=setTimeout(()=>fetchOS(v),350);
  });
  document.getElementById('btnBuscarOS').addEventListener('click',()=>{
    const v=osInp.value.trim();
    if(v) fetchOS(v);
  });

  function clearOSFields(){
    codigoInp.value=''; fazendaInp.value=''; areaInp.value='';
    operacaoInp.value=''; insumosTA.value='';
  }

  async function fetchOS(osValue){
    try{
      const url = `${APPS_SCRIPT_URL}?os=${encodeURIComponent(osValue)}`;
      const js  = await jsonp(url); // JSONP aqui
      if(!js.ok || !js.rows || !js.rows.length){ clearOSFields(); return; }

      const row = js.rows.find(x => String(x.OS) === String(osValue)) || js.rows[0];
      const get = k => row[k] ?? row[k?.toUpperCase()] ?? '';

      codigoInp.value   = get('CODIGO');
      fazendaInp.value  = get('FAZENDA');
      areaInp.value     = (get('AREA (HA)') || '').toString().replace(',','.');
      operacaoInp.value = get('OPERACAO');
      insumosTA.value   = get('INSUMOS');

      const objetivoSel = document.getElementById('objetivo');
      const objetivoStr = get('OBJETIVO');
      if (objetivoStr) {
        [...objetivoSel.options].forEach(o=>{
          if (o.value.toUpperCase() === String(objetivoStr).toUpperCase())
            objetivoSel.value = o.value;
        });
      }

      gerarTexto();
    }catch(e){
      console.error(e);
      clearOSFields();
    }
  }

  // Gera√ß√£o do texto / Copiar / WhatsApp
  const preview=document.getElementById('preview'),
        badgeFaz=document.getElementById('badgeFaz'),
        badgeArea=document.getElementById('badgeArea'),
        btnGerar=document.getElementById('btnGerar'),
        btnCopiar=document.getElementById('btnCopiar'),
        btnWhats=document.getElementById('btnWhats');

  btnGerar.addEventListener('click', gerarTexto);
  btnCopiar.addEventListener('click', ()=>{
    navigator.clipboard.writeText(preview.textContent || '').then(()=>{
      new bootstrap.Toast(document.getElementById('toastCopiado')).show();
    });
  });

  function gerarTexto(){
    const data=(document.getElementById('dataAplicacao').value||'').split('-').reverse().join('/');
    const unidade=document.getElementById('unidade').value;
    const frente =document.getElementById('frente').value;
    const piloto =document.getElementById('piloto').value;
    const auxiliar=document.getElementById('auxiliar').value;
    const drone  =document.getElementById('drone').value;
    const objetivo=document.getElementById('objetivo').value;
    const tipoProd=document.getElementById('tipoProduto').value;

    const os      =document.getElementById('os').value;
    const codigo  =document.getElementById('codigo').value;
    const fazenda =document.getElementById('fazenda').value;
    const area    =document.getElementById('area').value;
    const operacao=document.getElementById('operacao').value;
    const insumos =document.getElementById('insumos').value;
    const obs     =document.getElementById('observacoes').value.trim();

    const blocoObs = obs ? `\n*Observa√ß√µes:*  ${obs}` : '';

    const txt =
`üìÖ *Programa√ß√£o para aplica√ß√£o:* ${data}

*Unidade:* ${unidade || '-'}
*Frente:* ${frente || '-'}
*Piloto:* ${piloto || '-'}
*Auxiliar:* ${auxiliar || '-'}
*Drone:* ${drone || '-'}
*Objetivo:* ${objetivo || '-'}
*Tipo de Produto:* ${tipoProd || '-'}

*üìã OS:* ${os || '-'}
*C√≥digo:* ${codigo || '-'}
*Fazenda:* ${fazenda || '-'}

*√Årea (ha):* ${area || '-'}
*Opera√ß√£o:* ${operacao || '-'}
*Insumos:* ${insumos || '-'}${blocoObs}

*Resumo:*
*Qtd. Fazendas:* ${fazenda ? 1 : 0}
*Qtd. √Årea (ha):* ${area || 0}`;

    preview.textContent = txt;
    badgeFaz.textContent  = `Fazendas: ${fazenda ? 1 : 0}`;
    badgeArea.textContent = `√Årea: ${area || 0} ha`;
    btnWhats.href = 'https://wa.me/?text=' + encodeURIComponent(txt);
  }
</script>
</body>
</html>
